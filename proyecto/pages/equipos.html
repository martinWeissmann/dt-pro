<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Equipos</title>
  <link rel="stylesheet" href="..//styles/equipos.css">
</head>
<body>
  <div class="container">
    <h1>Gestión de Equipos</h1>
    <p id="user-email">Usuario: <span id="email"></span></p>
    <button id="logout-btn">Cerrar Sesión</button>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre del Equipo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn-add">Agregar Equipo</button>
  </div>

  <script type="module">
    // Importar cliente de Supabase
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configuración de Supabase
    const supabaseUrl = 'https://imokfxicqzmedegxskxp.supabase.co'; // Reemplazar con tu URL de Supabase
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltb2tmeGljcXptZWRlZ3hza3hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczMTY0MTMsImV4cCI6MjA1Mjg5MjQxM30.Hu763dw72zipJztCLyKy66fuwoW0_GTaLkw8PwKb_8s'; // Reemplazar con tu clave de API
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Elementos del DOM
    const addButton = document.querySelector('.btn-add');
    const tableBody = document.querySelector('table tbody');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmail = document.getElementById('email');

    // Obtener usuario actual
    const getUser = async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        alert('Por favor, inicia sesión.');
        window.location.href = 'registro.html'; // Redirige al login si no está autenticado
      }
      userEmail.textContent = user.email;
      return user;
    };

    // Cargar equipos desde la base de datos
    const loadTeams = async () => {
      const user = await getUser();
      const { data: teams, error } = await supabase
        .from('teams')
        .select('*')
        .eq('entrenador_id', user.id); // Filtrar por 'entrenador_id'
        console.log( "63",error)

      if (error) {
        console.error('Error cargando equipos:', error);
        return;
      }

      // Limpiar la tabla antes de recargar datos
      tableBody.innerHTML = '';

      // Agregar los equipos a la tabla
      teams.forEach((team, index) => addTeamToTable(team.name, index + 1, team.id));
    };

    // Guardar equipo en Supabase
    const saveTeam = async (name) => {
      const user = await getUser();
      const { error } = await supabase.from('teams').insert({
        name,
        entrenador_id: user.id, // Usar 'entrenador_id'
      });
      if (error) {
        console.error('Error guardando equipo:', error);
      } else {
        loadTeams(); // Actualizar equipos
      }
    };

    // Eliminar equipo en Supabase
    const deleteTeam = async (id) => {
      const { error } = await supabase.from('teams').delete().eq('id', id);
      if (error) {
        console.error('Error eliminando equipo:', error);
      } else {
        loadTeams(); // Actualizar equipos
      }
    };

    // Actualizar equipo en Supabase
    const updateTeam = async (id, name) => {
      const { error } = await supabase
        .from('teams')
        .update({ name })
        .eq('id', id);
      if (error) {
        console.error('Error actualizando equipo:', error);
      } else {
        loadTeams(); // Actualizar equipos
      }
    };

    // Agregar equipo a la tabla
    const addTeamToTable = (name, number, id) => {
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${number}</td>
        <td contenteditable="true">${name}</td>
        <td>
          <button class="btn-edit">Editar</button>
          <button class="btn-delete">Eliminar</button>
        </td>
      `;
      tableBody.appendChild(newRow);

      // Eventos de editar y eliminar
      newRow.querySelector('.btn-edit').addEventListener('click', () => {
        const newName = newRow.children[1].textContent.trim();
        if (newName) {
          updateTeam(id, newName);
        } else {
          alert('El nombre del equipo no puede estar vacío.');
        }
      });

      newRow.querySelector('.btn-delete').addEventListener('click', () => {
        if (confirm('¿Seguro que deseas eliminar este equipo?')) {
          deleteTeam(id);
        }
      });
    };

    // Agregar nuevo equipo
    const addTeam = async () => {
      const name = prompt('Ingrese el nombre del equipo:', 'Nuevo Equipo');
      if (name) {
        await saveTeam(name);
      }
    };

    // Cerrar sesión
    logoutBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error cerrando sesión:', error);
      }
      window.location.href = 'file:///C:/Users/marti/OneDrive/Documentos/dt-pro/proyecto/pages/registro.html'; // Redirige al login
    });

    // Evento para agregar equipo
    addButton.addEventListener('click', addTeam);

    // Cargar equipos al cargar la página
    loadTeams();
  </script>
</body>
</html>
